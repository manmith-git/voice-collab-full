<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Collaborative Code Editor</title>

<style>
html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0; 
    font-family: Arial, sans-serif;
}
#status {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #333;
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    font-size: 12px;
    z-index: 1000;
    max-width: 300px;
    border-radius: 4px;
}
#editor { 
    height: 100%; 
    width: 100%;
}
.error { color: #f00; }
.success { color: #0f0; }
.warning { color: #ff0; }
</style>
</head>

<body>
<div id="status">Loading...</div>
<div id="editor"></div>

<!-- Load libraries from CDN first -->
<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.min.js"></script>
<script src="https://unpkg.com/y-websocket@1.5.4/dist/y-websocket.min.js"></script>

<script>
// Diagnostic logging
function log(msg, type = 'info') {
    const status = document.getElementById('status');
    const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
    status.innerHTML += `<div class="${color}">${new Date().toLocaleTimeString()}: ${msg}</div>`;
    console.log(`[${type}]`, msg);
}

// Global error handler
window.onerror = function(msg, url, line, col, error) {
    log(`ERROR: ${msg}`, 'error');
    return false;
};

log('Page loaded', 'success');

// Verify YJS loaded
if (typeof Y === 'undefined') {
    log('YJS failed to load!', 'error');
} else {
    log('YJS loaded ✓', 'success');
}

// Configuration
const SERVER = window.location.origin;
const ROOM = new URLSearchParams(location.search).get("room") || "default";
log(`Room: ${ROOM}`, 'info');
log(`Server: ${SERVER}`, 'info');

// Load scripts dynamically
function loadScript(src, name) {
    return new Promise((resolve, reject) => {
        log(`Loading ${name}...`);
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
            log(`${name} loaded ✓`, 'success');
            resolve();
        };
        script.onerror = () => {
            log(`${name} failed ✗`, 'error');
            reject(new Error(`Failed to load ${name}`));
        };
        document.head.appendChild(script);
    });
}

async function init() {
    try {
        // Load Socket.IO
        await loadScript('/socket.io/socket.io.js', 'Socket.IO');
        
        // Check if YJS is available
        if (typeof Y === 'undefined') {
            throw new Error('YJS not loaded');
        }
        
        // Setup Socket.IO
        log('Connecting Socket.IO...');
        const socket = io(SERVER);
        
        socket.on('connect', () => {
            log('Socket.IO connected ✓', 'success');
            socket.emit("join-room", ROOM);
        });
        
        socket.on('connect_error', (err) => {
            log(`Socket.IO error: ${err.message}`, 'error');
        });
        
        // WebRTC setup
        const pc = new RTCPeerConnection({ 
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }] 
        });
        
        pc.ontrack = function(e) {
            log('Received audio track', 'success');
            let audio = new Audio();
            audio.srcObject = e.streams[0];
            audio.play().catch(err => log(`Audio: ${err.message}`, 'warning'));
        };
        
        pc.onicecandidate = function(e) {
            if (e.candidate && window.peerId) {
                socket.emit("signal", { 
                    to: window.peerId, 
                    signal: { ice: e.candidate } 
                });
            }
        };
        
        socket.on("signal", async function(data) {
            try {
                window.peerId = data.from;
                
                if (data.signal.sdp) {
                    await pc.setRemoteDescription(data.signal.sdp);
                    if (data.signal.sdp.type === "offer") {
                        let ans = await pc.createAnswer();
                        await pc.setLocalDescription(ans);
                        socket.emit("signal", { 
                            to: data.from, 
                            signal: { sdp: ans } 
                        });
                    }
                }
                
                if (data.signal.ice) {
                    await pc.addIceCandidate(data.signal.ice);
                }
            } catch (err) {
                log(`WebRTC: ${err.message}`, 'error');
            }
        });
        
        socket.on("user-joined", async function(id) {
            try {
                log(`User joined: ${id}`, 'success');
                window.peerId = id;
                let offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit("signal", { 
                    to: id, 
                    signal: { sdp: offer } 
                });
            } catch (err) {
                log(`WebRTC: ${err.message}`, 'error');
            }
        });
        
        // Load Monaco
        log('Loading Monaco...');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js', 'Monaco Loader');
        
        require.config({
            paths: { 
                vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs" 
            }
        });
        
        require(["vs/editor/editor.main"], function() {
            log('Monaco ready ✓', 'success');
            
            try {
                // Create YJS document
                const ydoc = new Y.Doc();
                log('YJS Doc created', 'success');
                
                // WebSocket URL
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/yjs`;
                
                log(`Connecting YJS: ${wsUrl}`);
                
                // Create WebSocket provider
                const provider = new window.WebsocketProvider(wsUrl, ROOM, ydoc);
                
                provider.on('status', event => {
                    log(`YJS: ${event.status}`, event.status === 'connected' ? 'success' : 'warning');
                });
                
                provider.on('connection-error', (err) => {
                    log(`YJS error: ${err}`, 'error');
                });
                
                const ytext = ydoc.getText("code");
                
                // Create Monaco editor
                log('Creating editor...');
                const editor = monaco.editor.create(
                    document.getElementById("editor"),
                    { 
                        value: "// Collaborative Code Editor\n// Room: " + ROOM + "\n\n", 
                        language: "javascript", 
                        theme: "vs-dark",
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: false }
                    }
                );
                
                log('Editor ready ✓', 'success');
                log('System operational!', 'success');
                
                // Sync YJS to Monaco
                let isLocalChange = false;
                
                ytext.observe(function() {
                    if (isLocalChange) return;
                    
                    let txt = ytext.toString();
                    if (txt !== editor.getValue()) {
                        const position = editor.getPosition();
                        editor.setValue(txt);
                        if (position) {
                            editor.setPosition(position);
                        }
                    }
                });
                
                // Sync Monaco to YJS
                editor.onDidChangeModelContent(function() {
                    let v = editor.getValue();
                    if (v !== ytext.toString()) {
                        isLocalChange = true;
                        ytext.delete(0, ytext.length);
                        ytext.insert(0, v);
                        isLocalChange = false;
                    }
                });
                
                // Fade status after 3 seconds
                setTimeout(() => {
                    document.getElementById('status').style.transition = 'opacity 1s';
                    document.getElementById('status').style.opacity = '0.1';
                }, 3000);
                
            } catch (err) {
                log(`Setup error: ${err.message}`, 'error');
            }
        }, function(err) {
            log(`Monaco error: ${err}`, 'error');
        });
        
    } catch (err) {
        log(`Init error: ${err.message}`, 'error');
    }
}

// Start when DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>

</body>
</html>