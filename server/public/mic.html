
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Mic</title></head>
<body>
<h3>Mic Active</h3>

<script src="https://cdn.jsdelivr.net/npm/yjs@13.6.8/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-websocket@1.5.0/dist/y-websocket.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const SERVER = "https://voice-collab-room.onrender.com";
const ROOM = new URLSearchParams(location.search).get("room") || "default";

const socket = io(SERVER);
socket.emit("join-room", ROOM);

const pc = new RTCPeerConnection({ iceServers:[{ urls:"stun:stun.l.google.com:19302" }] });

navigator.mediaDevices.getUserMedia({ audio:true }).then(function(stream){
    stream.getTracks().forEach(function(track){
        pc.addTrack(track, stream);
    });
});

pc.onicecandidate = function(e){
    if(e.candidate){
        socket.emit("signal", { to: window.peerId, signal: { ice: e.candidate } });
    }
};

socket.on("signal", async function(data){
    let from = data.from;
    let signal = data.signal;
    window.peerId = from;

    if(signal.sdp){
        await pc.setRemoteDescription(signal.sdp);
        if(signal.sdp.type === "offer"){
            let ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);
            socket.emit("signal", { to: from, signal: { sdp: ans } });
        }
    }

    if(signal.ice){
        await pc.addIceCandidate(signal.ice);
    }
});

socket.on("user-joined", async function(id){
    window.peerId = id;

    let offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    socket.emit("signal", { to: id, signal: { sdp: offer } });
});
</script>

</body>
</html>
