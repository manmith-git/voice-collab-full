<!doctype html>
<html>
<head><meta charset="utf-8"><title>Mic</title></head>
<body>
<h3>Mic Active</h3>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const SERVER = "https://voice-collab-room.onrender.com";
const ROOM = new URLSearchParams(location.search).get("room") || "default";

const socket = io(SERVER);
socket.emit("join-room", ROOM);

const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
});

pc.onicecandidate = e => {
    if (e.candidate) {
        socket.emit("signal", {
            to: window.peerId,
            signal: { ice: e.candidate }
        });
    }
};

socket.on("signal", async data => {
    const from = data.from;
    const signal = data.signal;
    window.peerId = from;

    if (signal.sdp) {
        await pc.setRemoteDescription(signal.sdp);

        if (signal.sdp.type === "offer") {
            const ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);

            socket.emit("signal", { to: from, signal: { sdp: ans } });
        }
    }

    if (signal.ice) {
        await pc.addIceCandidate(signal.ice);
    }
});

socket.on("user-joined", async id => {
    window.peerId = id;

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    socket.emit("signal", { to: id, signal: { sdp: offer } });
});
</script>

</body>
</html>
